---
interface Field {
	name: string;
	label: string;
	type: string;
	required: boolean;
	placeholder?: string;
	options?: string[];
	validation?: {
		minLength?: number;
		maxLength?: number;
		pattern?: string;
		min?: number;
		max?: number;
	};
}

interface Props {
	fields: Field[];
	formId: string;
	apiEndpoint: string;
}

const { fields, formId, apiEndpoint } = Astro.props;
---

<form id={formId} data-api={apiEndpoint} class="space-y-6 max-w-2xl">
	{
		fields.map((field) => (
			<div class="form-field">
				<label
					for={field.name}
					class="block text-sm font-medium text-gray-700 mb-2"
				>
					{field.label}
					{field.required && <span class="text-red-500">*</span>}
				</label>

				{field.type === "textarea" ? (
					<textarea
						id={field.name}
						name={field.name}
						required={field.required}
						placeholder={field.placeholder}
						minlength={field.validation?.minLength}
						maxlength={field.validation?.maxLength}
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
						rows="4"
					/>
				) : field.type === "select" ? (
					<select
						id={field.name}
						name={field.name}
						required={field.required}
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
					>
						<option value="">Seleccione una opción</option>
						{field.options?.map((option) => (
							<option value={option}>{option}</option>
						))}
					</select>
				) : field.type === "radio" ? (
					<div class="space-y-2">
						{field.options?.map((option) => (
							<label class="flex items-center">
								<input
									type="radio"
									name={field.name}
									value={option}
									required={field.required}
									class="mr-2"
								/>
								<span>{option}</span>
							</label>
						))}
					</div>
				) : field.type === "checkbox" ? (
					<label class="flex items-center">
						<input
							type="checkbox"
							id={field.name}
							name={field.name}
							required={field.required}
							class="mr-2 w-4 h-4"
						/>
						<span class="text-sm">{field.placeholder || field.label}</span>
					</label>
				) : (
					<input
						type={field.type as any}
						id={field.name}
						name={field.name}
						required={field.required}
						placeholder={field.placeholder}
						pattern={field.validation?.pattern}
						minlength={field.validation?.minLength}
						maxlength={field.validation?.maxLength}
						min={field.validation?.min}
						max={field.validation?.max}
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
					/>
				)}
			</div>
		))
	}

	<div class="flex gap-4">
		<button
			type="submit"
			class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
		>
			Enviar formulario
		</button>
		<button
			type="reset"
			class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
		>
			Limpiar
		</button>
	</div>
</form>

<div id="form-message" class="mt-4 hidden"></div>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const forms = document.querySelectorAll("form[data-api]");

		forms.forEach((form) => {
			form.addEventListener("submit", async (e) => {
				e.preventDefault();

				const formElement = e.target as HTMLFormElement;
				const apiEndpoint = formElement.dataset.api;
				const messageDiv = document.getElementById("form-message");

				if (!apiEndpoint || !messageDiv) return;

				const formData = new FormData(formElement);
				const submitButton = formElement.querySelector(
					'button[type="submit"]'
				) as HTMLButtonElement;

				// Deshabilitar botón durante envío
				submitButton.disabled = true;
				submitButton.textContent = "Enviando...";

				try {
					const response = await fetch(apiEndpoint, {
						method: "POST",
						body: formData,
					});

					const result = await response.json();

					messageDiv.classList.remove("hidden");

					if (result.success) {
						messageDiv.className =
							"mt-4 p-4 bg-green-100 text-green-700 rounded-lg";
						messageDiv.textContent =
							result.message || "✓ Formulario enviado exitosamente";
						formElement.reset();
					} else {
						messageDiv.className =
							"mt-4 p-4 bg-red-100 text-red-700 rounded-lg";
						messageDiv.textContent =
							result.error || "✗ Error al enviar el formulario";
					}
				} catch (error) {
					messageDiv.classList.remove("hidden");
					messageDiv.className = "mt-4 p-4 bg-red-100 text-red-700 rounded-lg";
					messageDiv.textContent = "✗ Error de conexión. Intente nuevamente.";
				} finally {
					submitButton.disabled = false;
					submitButton.textContent = "Enviar formulario";

					// Auto-ocultar mensaje después de 5 segundos
					setTimeout(() => {
						messageDiv.classList.add("hidden");
					}, 5000);
				}
			});
		});
	});
</script>
